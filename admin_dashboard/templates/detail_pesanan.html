{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Detail Pesanan #{{ transaksi.id }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4 text-center fw-bold order-detail-title" style="color: #059212;">Detail Pesanan #{{ transaksi.id }}</h2>
            
            <div class="card card-custom mb-4">
                <div class="card-header" style="background-color: #059212; color: #ECFFE6;">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="mb-0 order-info-title">Informasi Pesanan</h5>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <span class="badge" style="background-color: #ECFFE6; color: #059212;">
                                {{ transaksi.status_transaksi }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="order-date"><strong>Tanggal Transaksi:</strong> {{ transaksi.tanggal|date:"d M Y H:i" }}</p>
                            <p class="customer-name"><strong>Nama Pelanggan:</strong> {{ transaksi.pelanggan.nama_pelanggan }}</p>
                            {% if transaksi.alamat_pengiriman %}
                            <p class="shipping-address"><strong>Alamat Pengiriman:</strong> {{ transaksi.alamat_pengiriman }}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6 text-md-end">
                            <p class="total-payment"><strong>Total Pembayaran:</strong> <span class="fw-bold" style="color: #059212;">Rp {{ transaksi.total|intcomma }}</span></p>
                            {% if transaksi.bukti_bayar %}
                            <p class="payment-proof"><strong>Bukti Pembayaran:</strong> <a href="{{ transaksi.bukti_bayar.url }}" target="_blank">Lihat Bukti</a></p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <h4 class="mb-3 order-products-title" style="color: #059212;">Detail Produk</h4>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-success">
                        <tr>
                            <th>Produk</th>
                            <th>Harga</th>
                            <th>Jumlah</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for detail in detail_transaksi %}
                        <tr>
                            <td class="product-name">{{ detail.produk.nama_produk }}</td>
                            <td class="product-price">Rp {{ detail.produk.harga_produk|intcomma }}</td>
                            <td class="product-quantity">{{ detail.jumlah_produk|intcomma }}</td>
                            <td class="product-subtotal">Rp {{ detail.sub_total|intcomma }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="3" class="text-end">Total:</th>
                            <th>Rp {{ transaksi.total|intcomma }}</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <!-- Feedback Form -->
            {% if transaksi.status_transaksi == 'SELESAI' %}
            <div class="card card-custom mb-4">
                <div class="card-header" style="background-color: #059212; color: #ECFFE6;">
                    <h5 class="mb-0">Berikan Feedback</h5>
                </div>
                <div class="card-body">
                    {% if transaksi.feedback %}
                    <div class="alert alert-success">
                        <strong>Feedback Anda:</strong> {{ transaksi.feedback }}
                        {% if transaksi.fotofeedback %}
                        <br><strong>Foto Feedback:</strong><br>
                        <img src="{{ transaksi.fotofeedback.url }}" alt="Foto Feedback" class="img-fluid mt-2" style="max-height: 200px;">
                        {% endif %}
                    </div>
                    {% else %}
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="submit_feedback" value="1">
                        <div class="mb-3">
                            <label for="feedback" class="form-label">Feedback</label>
                            <textarea class="form-control" id="feedback" name="feedback" rows="3" placeholder="Bagikan pengalaman Anda dengan produk kami..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="fotofeedback" class="form-label">Foto (Opsional)</label>
                            <input class="form-control" type="file" id="fotofeedback" name="fotofeedback" accept="image/*">
                        </div>
                        <button type="submit" class="btn btn-success">Kirim Feedback</button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <div class="d-flex justify-content-between mt-4">
                <a href="{% url 'daftar_pesanan' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Kembali ke Daftar Pesanan
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    @media (max-width: 767px) {
        .order-detail-title {
            font-size: 1.5rem;
        }
        .order-info-title {
            font-size: 1.1rem;
        }
        .order-date, .customer-name, .shipping-address, .total-payment, .payment-proof {
            font-size: 0.9rem;
        }
        .order-products-title {
            font-size: 1.2rem;
        }
        .product-name, .product-price, .product-quantity, .product-subtotal {
            font-size: 0.85rem;
        }
        .table th, .table td {
            padding: 0.5rem;
        }
        .btn {
            font-size: 0.85rem;
            padding: 0.375rem 0.5rem;
        }
    }
</style>
{% endblock %}